// This is free and unencumbered software released into the public domain.
#include "geohash.h"

int
geohash_decode(double *lat, double *lon, const char *buf, int len)
{
    static const signed char value[256] = {
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        +0, +1, +2, +3, +4, +5, +6, +7, +8, +9, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, 10, 11, 12, 13, 14, 15, 16, -1, 17, 18, -1, 19, 20, -1,
        21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    };
    unsigned long long bits[2] = {0, 0};
    int lens[2] = {0, 0};

    len = len > 21 ? 21 : len;  // any further is pointless
    for (int i = 0; i < len; i++) {
        int a = i & 1;
        int b = !a;
        int c = value[buf[i]&0xff];
        if (c < 0) {
            return 0;
        }
        // deinterleave bits
        bits[b] = bits[b]<<1 | (c>>4 & 1);
        bits[a] = bits[a]<<1 | (c>>3 & 1);
        bits[b] = bits[b]<<1 | (c>>2 & 1);
        bits[a] = bits[a]<<1 | (c>>1 & 1);
        bits[b] = bits[b]<<1 | (c>>0 & 1);
        lens[b] += 3;
        lens[a] += 2;
    }

    // Note: Floating point operation order has been carefully arranged to
    // minimize rounding errors. Re-ordering (or using -ffast-math) will
    // cause tests to fail.
    double lat0 = (double)(bits[0] + 0) / (1ULL << lens[0]);
    double lat1 = (double)(bits[0] + 1) / (1ULL << lens[0]);
    *lat = (lat0 + lat1 - 1) * 90;
    double lon0 = (double)(bits[1] + 0) / (1ULL << lens[1]);
    double lon1 = (double)(bits[1] + 1) / (1ULL << lens[1]);
    *lon = (lon0 + lon1 - 1) * 180;

    return 1;
}

void
geohash_encode(char *buf, double lat, double lon)
{
    static const unsigned short interleave_b32[] = {
        0x3030, 0x3031, 0x3034, 0x3035, 0x3068, 0x306a, 0x306e, 0x3070,
        0x3230, 0x3231, 0x3234, 0x3235, 0x3268, 0x326a, 0x326e, 0x3270,
        0x3830, 0x3831, 0x3834, 0x3835, 0x3868, 0x386a, 0x386e, 0x3870,
        0x6230, 0x6231, 0x6234, 0x6235, 0x6268, 0x626a, 0x626e, 0x6270,
        0x3032, 0x3033, 0x3036, 0x3037, 0x306b, 0x306d, 0x3071, 0x3072,
        0x3232, 0x3233, 0x3236, 0x3237, 0x326b, 0x326d, 0x3271, 0x3272,
        0x3832, 0x3833, 0x3836, 0x3837, 0x386b, 0x386d, 0x3871, 0x3872,
        0x6232, 0x6233, 0x6236, 0x6237, 0x626b, 0x626d, 0x6271, 0x6272,
        0x3038, 0x3039, 0x3064, 0x3065, 0x3073, 0x3074, 0x3077, 0x3078,
        0x3238, 0x3239, 0x3264, 0x3265, 0x3273, 0x3274, 0x3277, 0x3278,
        0x3838, 0x3839, 0x3864, 0x3865, 0x3873, 0x3874, 0x3877, 0x3878,
        0x6238, 0x6239, 0x6264, 0x6265, 0x6273, 0x6274, 0x6277, 0x6278,
        0x3062, 0x3063, 0x3066, 0x3067, 0x3075, 0x3076, 0x3079, 0x307a,
        0x3262, 0x3263, 0x3266, 0x3267, 0x3275, 0x3276, 0x3279, 0x327a,
        0x3862, 0x3863, 0x3866, 0x3867, 0x3875, 0x3876, 0x3879, 0x387a,
        0x6262, 0x6263, 0x6266, 0x6267, 0x6275, 0x6276, 0x6279, 0x627a,
        0x3130, 0x3131, 0x3134, 0x3135, 0x3168, 0x316a, 0x316e, 0x3170,
        0x3330, 0x3331, 0x3334, 0x3335, 0x3368, 0x336a, 0x336e, 0x3370,
        0x3930, 0x3931, 0x3934, 0x3935, 0x3968, 0x396a, 0x396e, 0x3970,
        0x6330, 0x6331, 0x6334, 0x6335, 0x6368, 0x636a, 0x636e, 0x6370,
        0x3132, 0x3133, 0x3136, 0x3137, 0x316b, 0x316d, 0x3171, 0x3172,
        0x3332, 0x3333, 0x3336, 0x3337, 0x336b, 0x336d, 0x3371, 0x3372,
        0x3932, 0x3933, 0x3936, 0x3937, 0x396b, 0x396d, 0x3971, 0x3972,
        0x6332, 0x6333, 0x6336, 0x6337, 0x636b, 0x636d, 0x6371, 0x6372,
        0x3138, 0x3139, 0x3164, 0x3165, 0x3173, 0x3174, 0x3177, 0x3178,
        0x3338, 0x3339, 0x3364, 0x3365, 0x3373, 0x3374, 0x3377, 0x3378,
        0x3938, 0x3939, 0x3964, 0x3965, 0x3973, 0x3974, 0x3977, 0x3978,
        0x6338, 0x6339, 0x6364, 0x6365, 0x6373, 0x6374, 0x6377, 0x6378,
        0x3162, 0x3163, 0x3166, 0x3167, 0x3175, 0x3176, 0x3179, 0x317a,
        0x3362, 0x3363, 0x3366, 0x3367, 0x3375, 0x3376, 0x3379, 0x337a,
        0x3962, 0x3963, 0x3966, 0x3967, 0x3975, 0x3976, 0x3979, 0x397a,
        0x6362, 0x6363, 0x6366, 0x6367, 0x6375, 0x6376, 0x6379, 0x637a,
        0x3430, 0x3431, 0x3434, 0x3435, 0x3468, 0x346a, 0x346e, 0x3470,
        0x3630, 0x3631, 0x3634, 0x3635, 0x3668, 0x366a, 0x366e, 0x3670,
        0x6430, 0x6431, 0x6434, 0x6435, 0x6468, 0x646a, 0x646e, 0x6470,
        0x6630, 0x6631, 0x6634, 0x6635, 0x6668, 0x666a, 0x666e, 0x6670,
        0x3432, 0x3433, 0x3436, 0x3437, 0x346b, 0x346d, 0x3471, 0x3472,
        0x3632, 0x3633, 0x3636, 0x3637, 0x366b, 0x366d, 0x3671, 0x3672,
        0x6432, 0x6433, 0x6436, 0x6437, 0x646b, 0x646d, 0x6471, 0x6472,
        0x6632, 0x6633, 0x6636, 0x6637, 0x666b, 0x666d, 0x6671, 0x6672,
        0x3438, 0x3439, 0x3464, 0x3465, 0x3473, 0x3474, 0x3477, 0x3478,
        0x3638, 0x3639, 0x3664, 0x3665, 0x3673, 0x3674, 0x3677, 0x3678,
        0x6438, 0x6439, 0x6464, 0x6465, 0x6473, 0x6474, 0x6477, 0x6478,
        0x6638, 0x6639, 0x6664, 0x6665, 0x6673, 0x6674, 0x6677, 0x6678,
        0x3462, 0x3463, 0x3466, 0x3467, 0x3475, 0x3476, 0x3479, 0x347a,
        0x3662, 0x3663, 0x3666, 0x3667, 0x3675, 0x3676, 0x3679, 0x367a,
        0x6462, 0x6463, 0x6466, 0x6467, 0x6475, 0x6476, 0x6479, 0x647a,
        0x6662, 0x6663, 0x6666, 0x6667, 0x6675, 0x6676, 0x6679, 0x667a,
        0x3530, 0x3531, 0x3534, 0x3535, 0x3568, 0x356a, 0x356e, 0x3570,
        0x3730, 0x3731, 0x3734, 0x3735, 0x3768, 0x376a, 0x376e, 0x3770,
        0x6530, 0x6531, 0x6534, 0x6535, 0x6568, 0x656a, 0x656e, 0x6570,
        0x6730, 0x6731, 0x6734, 0x6735, 0x6768, 0x676a, 0x676e, 0x6770,
        0x3532, 0x3533, 0x3536, 0x3537, 0x356b, 0x356d, 0x3571, 0x3572,
        0x3732, 0x3733, 0x3736, 0x3737, 0x376b, 0x376d, 0x3771, 0x3772,
        0x6532, 0x6533, 0x6536, 0x6537, 0x656b, 0x656d, 0x6571, 0x6572,
        0x6732, 0x6733, 0x6736, 0x6737, 0x676b, 0x676d, 0x6771, 0x6772,
        0x3538, 0x3539, 0x3564, 0x3565, 0x3573, 0x3574, 0x3577, 0x3578,
        0x3738, 0x3739, 0x3764, 0x3765, 0x3773, 0x3774, 0x3777, 0x3778,
        0x6538, 0x6539, 0x6564, 0x6565, 0x6573, 0x6574, 0x6577, 0x6578,
        0x6738, 0x6739, 0x6764, 0x6765, 0x6773, 0x6774, 0x6777, 0x6778,
        0x3562, 0x3563, 0x3566, 0x3567, 0x3575, 0x3576, 0x3579, 0x357a,
        0x3762, 0x3763, 0x3766, 0x3767, 0x3775, 0x3776, 0x3779, 0x377a,
        0x6562, 0x6563, 0x6566, 0x6567, 0x6575, 0x6576, 0x6579, 0x657a,
        0x6762, 0x6763, 0x6766, 0x6767, 0x6775, 0x6776, 0x6779, 0x677a,
        0x6830, 0x6831, 0x6834, 0x6835, 0x6868, 0x686a, 0x686e, 0x6870,
        0x6b30, 0x6b31, 0x6b34, 0x6b35, 0x6b68, 0x6b6a, 0x6b6e, 0x6b70,
        0x7330, 0x7331, 0x7334, 0x7335, 0x7368, 0x736a, 0x736e, 0x7370,
        0x7530, 0x7531, 0x7534, 0x7535, 0x7568, 0x756a, 0x756e, 0x7570,
        0x6832, 0x6833, 0x6836, 0x6837, 0x686b, 0x686d, 0x6871, 0x6872,
        0x6b32, 0x6b33, 0x6b36, 0x6b37, 0x6b6b, 0x6b6d, 0x6b71, 0x6b72,
        0x7332, 0x7333, 0x7336, 0x7337, 0x736b, 0x736d, 0x7371, 0x7372,
        0x7532, 0x7533, 0x7536, 0x7537, 0x756b, 0x756d, 0x7571, 0x7572,
        0x6838, 0x6839, 0x6864, 0x6865, 0x6873, 0x6874, 0x6877, 0x6878,
        0x6b38, 0x6b39, 0x6b64, 0x6b65, 0x6b73, 0x6b74, 0x6b77, 0x6b78,
        0x7338, 0x7339, 0x7364, 0x7365, 0x7373, 0x7374, 0x7377, 0x7378,
        0x7538, 0x7539, 0x7564, 0x7565, 0x7573, 0x7574, 0x7577, 0x7578,
        0x6862, 0x6863, 0x6866, 0x6867, 0x6875, 0x6876, 0x6879, 0x687a,
        0x6b62, 0x6b63, 0x6b66, 0x6b67, 0x6b75, 0x6b76, 0x6b79, 0x6b7a,
        0x7362, 0x7363, 0x7366, 0x7367, 0x7375, 0x7376, 0x7379, 0x737a,
        0x7562, 0x7563, 0x7566, 0x7567, 0x7575, 0x7576, 0x7579, 0x757a,
        0x6a30, 0x6a31, 0x6a34, 0x6a35, 0x6a68, 0x6a6a, 0x6a6e, 0x6a70,
        0x6d30, 0x6d31, 0x6d34, 0x6d35, 0x6d68, 0x6d6a, 0x6d6e, 0x6d70,
        0x7430, 0x7431, 0x7434, 0x7435, 0x7468, 0x746a, 0x746e, 0x7470,
        0x7630, 0x7631, 0x7634, 0x7635, 0x7668, 0x766a, 0x766e, 0x7670,
        0x6a32, 0x6a33, 0x6a36, 0x6a37, 0x6a6b, 0x6a6d, 0x6a71, 0x6a72,
        0x6d32, 0x6d33, 0x6d36, 0x6d37, 0x6d6b, 0x6d6d, 0x6d71, 0x6d72,
        0x7432, 0x7433, 0x7436, 0x7437, 0x746b, 0x746d, 0x7471, 0x7472,
        0x7632, 0x7633, 0x7636, 0x7637, 0x766b, 0x766d, 0x7671, 0x7672,
        0x6a38, 0x6a39, 0x6a64, 0x6a65, 0x6a73, 0x6a74, 0x6a77, 0x6a78,
        0x6d38, 0x6d39, 0x6d64, 0x6d65, 0x6d73, 0x6d74, 0x6d77, 0x6d78,
        0x7438, 0x7439, 0x7464, 0x7465, 0x7473, 0x7474, 0x7477, 0x7478,
        0x7638, 0x7639, 0x7664, 0x7665, 0x7673, 0x7674, 0x7677, 0x7678,
        0x6a62, 0x6a63, 0x6a66, 0x6a67, 0x6a75, 0x6a76, 0x6a79, 0x6a7a,
        0x6d62, 0x6d63, 0x6d66, 0x6d67, 0x6d75, 0x6d76, 0x6d79, 0x6d7a,
        0x7462, 0x7463, 0x7466, 0x7467, 0x7475, 0x7476, 0x7479, 0x747a,
        0x7662, 0x7663, 0x7666, 0x7667, 0x7675, 0x7676, 0x7679, 0x767a,
        0x6e30, 0x6e31, 0x6e34, 0x6e35, 0x6e68, 0x6e6a, 0x6e6e, 0x6e70,
        0x7130, 0x7131, 0x7134, 0x7135, 0x7168, 0x716a, 0x716e, 0x7170,
        0x7730, 0x7731, 0x7734, 0x7735, 0x7768, 0x776a, 0x776e, 0x7770,
        0x7930, 0x7931, 0x7934, 0x7935, 0x7968, 0x796a, 0x796e, 0x7970,
        0x6e32, 0x6e33, 0x6e36, 0x6e37, 0x6e6b, 0x6e6d, 0x6e71, 0x6e72,
        0x7132, 0x7133, 0x7136, 0x7137, 0x716b, 0x716d, 0x7171, 0x7172,
        0x7732, 0x7733, 0x7736, 0x7737, 0x776b, 0x776d, 0x7771, 0x7772,
        0x7932, 0x7933, 0x7936, 0x7937, 0x796b, 0x796d, 0x7971, 0x7972,
        0x6e38, 0x6e39, 0x6e64, 0x6e65, 0x6e73, 0x6e74, 0x6e77, 0x6e78,
        0x7138, 0x7139, 0x7164, 0x7165, 0x7173, 0x7174, 0x7177, 0x7178,
        0x7738, 0x7739, 0x7764, 0x7765, 0x7773, 0x7774, 0x7777, 0x7778,
        0x7938, 0x7939, 0x7964, 0x7965, 0x7973, 0x7974, 0x7977, 0x7978,
        0x6e62, 0x6e63, 0x6e66, 0x6e67, 0x6e75, 0x6e76, 0x6e79, 0x6e7a,
        0x7162, 0x7163, 0x7166, 0x7167, 0x7175, 0x7176, 0x7179, 0x717a,
        0x7762, 0x7763, 0x7766, 0x7767, 0x7775, 0x7776, 0x7779, 0x777a,
        0x7962, 0x7963, 0x7966, 0x7967, 0x7975, 0x7976, 0x7979, 0x797a,
        0x7030, 0x7031, 0x7034, 0x7035, 0x7068, 0x706a, 0x706e, 0x7070,
        0x7230, 0x7231, 0x7234, 0x7235, 0x7268, 0x726a, 0x726e, 0x7270,
        0x7830, 0x7831, 0x7834, 0x7835, 0x7868, 0x786a, 0x786e, 0x7870,
        0x7a30, 0x7a31, 0x7a34, 0x7a35, 0x7a68, 0x7a6a, 0x7a6e, 0x7a70,
        0x7032, 0x7033, 0x7036, 0x7037, 0x706b, 0x706d, 0x7071, 0x7072,
        0x7232, 0x7233, 0x7236, 0x7237, 0x726b, 0x726d, 0x7271, 0x7272,
        0x7832, 0x7833, 0x7836, 0x7837, 0x786b, 0x786d, 0x7871, 0x7872,
        0x7a32, 0x7a33, 0x7a36, 0x7a37, 0x7a6b, 0x7a6d, 0x7a71, 0x7a72,
        0x7038, 0x7039, 0x7064, 0x7065, 0x7073, 0x7074, 0x7077, 0x7078,
        0x7238, 0x7239, 0x7264, 0x7265, 0x7273, 0x7274, 0x7277, 0x7278,
        0x7838, 0x7839, 0x7864, 0x7865, 0x7873, 0x7874, 0x7877, 0x7878,
        0x7a38, 0x7a39, 0x7a64, 0x7a65, 0x7a73, 0x7a74, 0x7a77, 0x7a78,
        0x7062, 0x7063, 0x7066, 0x7067, 0x7075, 0x7076, 0x7079, 0x707a,
        0x7262, 0x7263, 0x7266, 0x7267, 0x7275, 0x7276, 0x7279, 0x727a,
        0x7862, 0x7863, 0x7866, 0x7867, 0x7875, 0x7876, 0x7879, 0x787a,
        0x7a62, 0x7a63, 0x7a66, 0x7a67, 0x7a75, 0x7a76, 0x7a79, 0x7a7a,
    };
    unsigned long long blat = (lat +  90) / 180 * (1ULL << 50);
    unsigned long long blon = (lon + 180) / 360 * (1ULL << 50);
    unsigned short chunks[] = {
        interleave_b32[(blon >> 40 & 0x3e0) | (blat >> 45 & 0x01f)],
        interleave_b32[(blon >> 35 & 0x3e0) | (blat >> 40 & 0x01f)],
        interleave_b32[(blon >> 30 & 0x3e0) | (blat >> 35 & 0x01f)],
        interleave_b32[(blon >> 25 & 0x3e0) | (blat >> 30 & 0x01f)],
        interleave_b32[(blon >> 20 & 0x3e0) | (blat >> 25 & 0x01f)],
        interleave_b32[(blon >> 15 & 0x3e0) | (blat >> 20 & 0x01f)],
        interleave_b32[(blon >> 10 & 0x3e0) | (blat >> 15 & 0x01f)],
        interleave_b32[(blon >>  5 & 0x3e0) | (blat >> 10 & 0x01f)],
        interleave_b32[(blon >>  0 & 0x3e0) | (blat >>  5 & 0x01f)],
        interleave_b32[(blon <<  5 & 0x3e0) | (blat >>  0 & 0x01f)],
    };
    buf[ 0] = chunks[0] >> 8;
    buf[ 1] = chunks[0] >> 0;
    buf[ 2] = chunks[1] >> 8;
    buf[ 3] = chunks[1] >> 0;
    buf[ 4] = chunks[2] >> 8;
    buf[ 5] = chunks[2] >> 0;
    buf[ 6] = chunks[3] >> 8;
    buf[ 7] = chunks[3] >> 0;
    buf[ 8] = chunks[4] >> 8;
    buf[ 9] = chunks[4] >> 0;
    buf[10] = chunks[5] >> 8;
    buf[11] = chunks[5] >> 0;
    buf[12] = chunks[6] >> 8;
    buf[13] = chunks[6] >> 0;
    buf[14] = chunks[7] >> 8;
    buf[15] = chunks[7] >> 0;
    buf[16] = chunks[8] >> 8;
    buf[17] = chunks[8] >> 0;
    buf[18] = chunks[9] >> 8;
    buf[19] = chunks[9] >> 0;
}
